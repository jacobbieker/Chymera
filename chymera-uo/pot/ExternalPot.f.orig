      subroutine ExternalPot(ITSTEP)
      implicit none
#include "hydroparam.h"
#include "globals.h"
#include "units.h"

      integer::J,K,L,ITSTEP
      real*8::thisMass,omegaBin2,rcom,theta,x,y
      real*8::rBin,thetaBin,thisTime,omegaBin,massDisk,muMass,rdist
      thisTime=time

#if BINARY>0
      call getBinaryPosition(thisTime,rBin,thetaBin,omegaBin,
     &   massDisk,muMass)
      omegaBin2=omegabin**2
      rcom=rbin-rbin*mass_star/muMass
#endif
c Hard wired for temporary testing. use this to test wiggle, else
c comment it out.
             indirectx = rpstar*cos(phi_star)
             indirecty = rpstar*sin(phi_star)

#if INDIRECT>0
!$OMP DO SCHEDULE(STATIC) REDUCTION(+:indirectx,indirecty)
c Then calculate the position of the star is such that the center of
c mass of the system remains zero.
      do L=1,LMAX
        do K=2,KMAX1
          do J=JMIN,JMAX1
             thisMass=rho(J,K,L)*rhf(J)*rof3n*zof3n*two*dtheta ! take into account both sides

             indirectx=indirectx+thisMass*cos((dble(L-1)+half)*dtheta)
     &                *rhf(J)
             indirecty=indirecty+thisMass*sin((dble(L-1)+half)*dtheta)
     &                *rhf(J)


          enddo
        enddo
      enddo
!$OMP ENDDO
             indirectx = -indirectx/mass_star
             indirecty = -indirecty/mass_star
c             write(98,"a") "this should not print if INDIRECT=0"
#endif

!$OMP DO SCHEDULE(STATIC) PRIVATE(theta,rdist,x,y)
            do l=1,lmax
       theta=(dble(L)-half)*dtheta
                do k=1,kmax2
                  do j=1,jmax2
                     starphi(j,k,l) = -(mass_star+tmassacc)
     & /sqrt(rhf(J)*rhf(J)+zhf(K)*zhf(K) + indirectx*indirectx
     &  + indirecty*indirecty - two*rhf(J)
     & *(cos((dble(L-1)+half)*dtheta)*indirectx 
     & + sin((dble(L-1)+half)*dtheta)*indirecty))    
                     phi(j,k,l)= phi(j,k,l)+starphi(j,k,l) ! ELIMINATED diskphi. ACB.
                    
c       This is where the new star cm should be taken acount of, not
c       added below.
#if BINARY>0
       !!!!!!!!!!!!!!
       !! Add Binary!
       !!!!!!!!!!!!!!

       rdist=sqrt(rBin*rBin+rhf(J)*rhf(J)-two*rBin*rhf(J)*
     &       cos( theta- pi ) +
     &       zhf(K)*zhf(K) )

       x=rhf(J)*cos( theta )
       y=rhf(J)*sin( theta )

       phi(J,K,L)=phi(J,K,L)-massBin/rdist-half*omegaBin2*
     &            ( (x+rcom)**2+y**2 )
#endif

c#if INDIRECT>0
c       !!!!!!!!!!!!!!!!
c       !! Add Indirect!
c       !!!!!!!!!!!!!!!!
c                     phi(J,K,L)=phi(J,K,L)
c     &+indirectx*rhf(J)*cos((dble(L-1)+half)*dtheta)
c     &+indirecty*rhf(J)*sin((dble(L-1)+half)*dtheta)

c                     phi(j,k,l)=phi(j,k,l)
c     &+(indirectx2*rhf(J)+indirecty2*(dble(L-1)+half)*dtheta)
c     &+mass_star*(indirectx*rhf(J)
c     &*cos((dble(L-1)+half)*dtheta)/sqrt(rhf(J)**2+zhf(k)**2)**3
c     &+(indirecty2*rhf(J)-indirectx2*(dble(L-1)+half)*dtheta)
c     &+indirecty*rhf(J)
c     &*sin((dble(L-1)+half)*dtheta)/sqrt(rhf(j)**2+zhf(k)**2)**3
c     &+half*(indirectx**2+indirecty**2)/sqrt(rhf(J)**2+zhf(k)**2)**3)

c#endif 

                  enddo
               enddo
            enddo
!$OMP END DO
!                IF(MOD(ITSTEP,10).EQ.0) THEN
!        write(99,*) thisTime,indirectx,indirecty
!                END IF
c!$OMP MASTER
c       if(mod(ITSTEP,50).eq.0) then
c        write(97,"(a)") 'time,indirectx,indirecty'
c        write(97,"(3(1pe9.4,1x))") time,indirectx,indirecty
c        write(97,"(a)") 'phi(j,2,20),starphi(j,2,20)'
c        do j=1,jmax2
c        write(97,"(I4,1x,2(1pe9.4,1x))") j,phi(j,2,20),starphi(j,2,20)
c     &                           
c        enddo
c       endif
c!$OMP END MASTER
      return
      end subroutine ExternalPot
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
      subroutine ExternalPotInit() ! this should be obsolete now
      implicit none
#include "hydroparam.h"
#include "globals.h"
#include "units.h"

      real*8::rBin,thetaBin,thisTime,omegaBin,massDisk,muMass,theta
      integer::J,K,L
      real*8::thisMass,omegaBin2,rcom,x,y,rdist

#if BINARY>0
      call getBinaryPosition(thisTime,rBin,thetaBin,omegaBin,
     &   massDisk,muMass)
      omegaBin2=omegaBin**2
      rcom=rBin-rBin*(mass_star)/muMass
#endif

#if INDIRECT>0
!$OMP DO SCHEDULE(STATIC) REDUCTION(+:indirectx,indirecty) 
!$OMP&PRIVATE(thisMass)
      do L=1,LMAX
        do K=2,KMAX1
          do J=JMIN,JMAX1
             thisMass=rho(J,K,L)*rhf(J)*rof3n*zof3n*two*dtheta ! take into account both sides
             indirectx=indirectx+thisMass*cos((dble(L-1)+half)*dtheta)
     &                *rhf(J)/(sqrt(rhf(J)*rhf(J)+zhf(K)*zhf(K)))**3
             indirecty=indirecty+thisMass*sin((dble(L-1)+half)*dtheta)
     &                *rhf(J)/(sqrt(rhf(J)*rhf(J)+zhf(K)*zhf(K)))**3
          enddo
        enddo
      enddo
!$OMP ENDDO
#endif

 
!$OMP DO SCHEDULE(STATIC) private(rdist,x,y)
            do l=1,lmax
       theta=(dble(L)-half)*dtheta
                do k=1,kmax2
                  do j=1,jmax2
                     starphi(j,k,l) = -(mass_star+tmassacc)
     &                       /(sqrt(rhf(J)*rhf(J)+zhf(K)*zhf(K)))
                     phi(j,k,l)= phi(j,k,l)+starphi(j,k,l) ! ELIMINATED diskphi. ACB.
#if BINARY>0
       !!!!!!!!!!!!!!
       !! Add Binary!
       !!!!!!!!!!!!!!

       rdist=sqrt(rBin*rBin+rhf(J)*rhf(J)-two*rBin*rhf(J)*
     &       cos( theta- pi ) +
     &       zhf(K)*zhf(K) )

       x=rhf(J)*cos( theta )
       y=rhf(J)*sin( theta )

       phi(J,K,L)=phi(J,K,L)-massBin/rdist-half*omegaBin2*
     &            ( (x+rcom)**2+y**2 )
#endif

#if INDIRECT>0
       !!!!!!!!!!!!!!!!
       !! Add Indirect!
       !!!!!!!!!!!!!!!!
                     phi(J,K,L)=phi(J,K,L)
     &+indirectx*rhf(J)*cos((dble(L-1)+half)*dtheta)
     &+indirecty*rhf(J)*sin((dble(L-1)+half)*dtheta)
#endif
                  enddo
               enddo
            enddo
!$OMP END DO

      return
      end subroutine ExternalPotInit
